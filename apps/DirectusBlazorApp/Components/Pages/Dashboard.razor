@page "/dashboard"
@rendermode InteractiveServer
@using DirectusBlazorApp.Services
@using Directus.Net.Abstractions
@inject DirectusAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Dashboard</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">Dashboard</h1>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @errorMessage
        </div>
    }

    @if (currentUser != null)
    {
        <div class="card shadow-sm mt-3">
            <div class="card-body p-4">
                <h5 class="card-title mb-3"><i class="bi bi-person-circle me-2"></i>Welcome, @currentUser.Email</h5>

                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><i class="bi bi-person-bounding-box me-2"></i><strong>Name:</strong> @currentUser.FirstName @currentUser.LastName</p>
                        <p class="mb-2"><i class="bi bi-envelope-at-fill me-2"></i><strong>Email:</strong> @currentUser.Email</p>
                        <p class="mb-2"><i class="bi bi-person-vcard-fill me-2"></i><strong>ID:</strong> @currentUser.Id</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><i class="bi bi-shield-fill-check me-2"></i><strong>Role:</strong> @currentUser.Role</p>
                        <p class="mb-2"><i class="bi bi-heart-pulse-fill me-2"></i><strong>Status:</strong> @currentUser.Status</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <button class="btn btn-lg btn-outline-danger" @onclick="HandleLogoutAsync">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
        </div>
    }
    else if (isLoading)
    {
        <p>Loading user information...</p>
    }
    else
    {
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            <div>
                Not authenticated. Please <a href="/login" class="alert-link">log in</a>.
            </div>
        </div>
    }
</div>

@code {
    private DirectusUser? currentUser;
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            var isAuthenticated = await AuthService.IsAuthenticatedAsync();

            if (!isAuthenticated)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser == null)
            {
                errorMessage = "Failed to retrieve current user information.";
                Navigation.NavigateTo("/login");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user: {ex.Message}");
            errorMessage = $"An error occurred: {ex.Message}";
            Navigation.NavigateTo("/login");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleLogoutAsync()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/");
    }
}